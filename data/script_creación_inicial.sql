-- LOGIN Y USUARIO

CREATE TABLE FUNCION_POR_ROL(
	FUN_ID INT IDENTITY(1,1),
	NOMBRE VARCHAR(120),
	ROL INT
)

CREATE TABLE ROLES(
	ROL_ID INT PRIMARY KEY,
	NOMBRE VARCHAR(50),
	ESTADO BIT
)

CREATE TABLE INTENTOS_LOGIN(
	INT_ID INT IDENTITY(1,1),
	USUARIO INT,
	FECHA DATE,
	ACCESO BIT -- 1 ES CORRECTO
)

CREATE TABLE PAISES(
	PAI_ID INT PRIMARY KEY,
	NOMBRE VARCHAR(250)
)

CREATE TABLE ROLES_POR_USUARIO(
	ROL INT,
	USUARIO INT
)

CREATE TABLE TIPOS_DOCUMENTO( --NO ESTÁ EN EL DER
	TIP_ID INT,
	NOMBRE VARCHAR(255)
)

CREATE TABLE USUARIOS(
	USU_ID INT PRIMARY KEY,
	USERNAME VARCHAR(40),
	PASSWORD VARCHAR(40),
	ESTADO BIT,
	FECHA_ALTA DATE, --TODO FALTA EN EL DER
	FECHA_MODIFICACION DATE, --TODO FALTA EN EL DER
	INTENTOS_FALLIDOS SMALLINT, --RESETEAR CUANDO INGRESA
	PREGUNTA_SECRETA VARCHAR(100),
	RESPUESTA VARCHAR(100)
)

CREATE TABLE PERSONAS(
	PER_ID INT PRIMARY KEY,
	TIPO_DOC INT,
	DNI INT, --FIXME ¿INT? ¿NUMERIC(10,0)?
	NOMBRE VARCHAR(255),
	APELLIDO VARCHAR(255),
	PAIS INT,
	CALLE VARCHAR(255),
	PISO INT,
	DEPTO VARCHAR(10), --SIGUIENDO EL ESQUEMA DE LA MAESTRA
	LOCALIDAD INT,
	NACIONALIDAD INT,
	FECHA_NACIMIENTO DATE,
	MAIL VARCHAR(255),
	USUARIO INT	
)

CREATE TABLE LOCALIDADES( --NO ESTÁ EN EL DER
	LOC_ID INT PRIMARY KEY,
	NOMBRE VARCHAR(255)
)

-- CUENTAS Y TARJETAS

CREATE TABLE MONEDAS(
	MON_ID INT PRIMARY KEY,
	NOMBRE VARCHAR(30)
)

CREATE TABLE EMISORES(
	EMI_ID INT IDENTITY(1,1),
	NOMBRE VARCHAR(255)
)

CREATE TABLE TIPOS_CUENTA(
	TIP_ID INT PRIMARY KEY,
	NOMBRE VARCHAR(9), --ORO/PLATA/BRONCE/GRATUITA TODO CHECK
	COSTO_MANTENIMIENTO FLOAT,
	COSTO_TRANSACCION FLOAT
)

CREATE TABLE ESTADOS_CUENTA(
	EST_ID INT PRIMARY KEY,
	NOMBRE VARCHAR(30),
	FECHA_CIERRE DATE --TIENE LÓGICA ÉSTO?
)

CREATE TABLE CUENTAS(
	CUE_ID INT PRIMARY KEY,
	USUARIO INT,
	PAIS INT,
	MONEDA INT,
	TIPO INT,
	FECHA_ALTA DATE,
	FECHA_EXPIRACION DATE,
	ESTADO INT,
	SALDO FLOAT
)

CREATE TABLE TARJETAS(
	TAR_ID INT PRIMARY KEY,
	PERSONA INT,
	ENCRIPTADO NUMERIC(12,0),
	LIMPIO NUMERIC(4,0), --FIXME ASÍ?
	COD_SEGURIDAD INT,
	EMISOR INT,
	FECHA_EMISION DATE,
	FECHA_VENCIMIENTO DATE,
)

-- OPERACIONES
CREATE TABLE CHEQUES(
	CHE_ID INT IDENTITY(1,1),
	NUMERO INT
)

CREATE TABLE DEPOSITOS(
	DEP_ID INT PRIMARY KEY,
	TARJETA INT
)

CREATE TABLE RETIROS_EFECTIVO(
	RET_ID INT PRIMARY KEY,
	CHEQUE INT
)

CREATE TABLE TRANSFERENCIAS(
	TRA_ID INT PRIMARY KEY,
	CUENTA_DESTINO INT,
	COSTO FLOAT
)

CREATE TABLE OPERACIONES(
	OPE_ID INT PRIMARY KEY,
	CUENTA INT,
	MONEDA INT,
	FECHA DATE,
	IMPORTE FLOAT
)

CREATE TABLE FACTURAS(
	FAC_ID INT PRIMARY KEY,
	DESCRIPCION VARCHAR(255), --NO ESTÁ EN EL DER
	OPERACION INT,
	FECHA DATE,
	PAGADO BIT
)

--ALTER(S) DE TABLAS
 --TODO


--INSERTANDO DATOS EN LAS TABLAS (MIGRACIÓN)

INSERT INTO PAISES --AGREGANDO PAÍSES EXISTENTES DE LA TABLA MAESTRA

SELECT DISTINCT Cli_Pais_Codigo, Cli_Pais_Desc FROM gd_esquema.Maestra
UNION
SELECT DISTINCT Cuenta_Pais_Codigo, Cuenta_Pais_Desc FROM gd_esquema.Maestra
UNION
SELECT DISTINCT Cuenta_Dest_Pais_Codigo, Cuenta_Dest_Pais_Desc FROM gd_esquema.Maestra
WHERE Cuenta_Dest_Pais_Codigo IS NOT NULL
ORDER BY Cli_Pais_Codigo;

INSERT INTO MONEDAS --AGREGANDO LA ÚNICA MOENDA EXISTENTE POR AHORA
VALUES(1, 'Dólar EE UU')

INSERT INTO ESTADOS_CUENTA --AGREGANDO LOS ESTADOS DE CUENTA MANUALMENTE YA QUE NO HAY CARGADOS
VALUES(1, 'Habilitada', NULL)
INSERT INTO ESTADOS_CUENTA
VALUES(2, 'Deshabilitada', NULL)
INSERT INTO ESTADOS_CUENTA
VALUES(3, 'Pendiente de activación', NULL)
INSERT INTO ESTADOS_CUENTA
VALUES(4, 'Cerrada', NULL)

INSERT INTO TIPOS_CUENTA --AGREGANDO TIPOS DE CUENTA FIJOS CON UN COSTO HARDCODEADO
VALUES(1, 'Gratuita', 0, 100)
INSERT INTO TIPOS_CUENTA
VALUES(2, 'Bronce', 10, 50)
INSERT INTO TIPOS_CUENTA
VALUES(3, 'Plata', 20, 15)
INSERT INTO TIPOS_CUENTA
VALUES(4, 'Oro', 30, 0)

INSERT INTO EMISORES --AGREGANDO EMISORES EXISTENTES CON IDENTITY

SELECT DISTINCT Tarjeta_Emisor_Descripcion FROM gd_esquema.Maestra
WHERE Tarjeta_Emisor_Descripcion IS NOT NULL

INSERT INTO TIPOS_DOCUMENTO --AGREGANDO TIPOS DE DOCUMENTOS EXISTENTES EN TABLA MAESTRA Y MANUALES
SELECT DISTINCT Cli_Tipo_Doc_Cod, Cli_Tipo_Doc_Desc FROM gd_esquema.Maestra
INSERT INTO TIPOS_DOCUMENTO
VALUES(10003, 'DNI')
INSERT INTO TIPOS_DOCUMENTO
VALUES(10004, 'LE')
INSERT INTO TIPOS_DOCUMENTO
VALUES(10005, 'LC')

SELECT * FROM gd_esquema.Maestra